# ä¸Šä¼ æ¨¡å—æ–‡æ¡£

## æ¦‚è¿°

æœ¬ä¸Šä¼ æ¨¡å—æä¾›äº†å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒç®€å•ä¸Šä¼ å’Œå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ä¸¤ç§æ–¹å¼ï¼Œå…·å¤‡MD5å»é‡ã€æ–­ç‚¹ç»­ä¼ ã€è¿›åº¦æŸ¥è¯¢ç­‰åŠŸèƒ½ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸš€ åŠŸèƒ½ç‰¹æ€§
- **åŒæ¨¡å¼ä¸Šä¼ **ï¼šæ”¯æŒç®€å•ä¸Šä¼ å’Œåˆ†ç‰‡ä¸Šä¼ 
- **ç§’ä¼ åŠŸèƒ½**ï¼šåŸºäºMD5å“ˆå¸Œçš„æ–‡ä»¶å»é‡
- **æ–­ç‚¹ç»­ä¼ **ï¼šåˆ†ç‰‡ä¸Šä¼ æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- **è¿›åº¦æŸ¥è¯¢**ï¼šå®æ—¶æŸ¥è¯¢ä¸Šä¼ è¿›åº¦
- **ç±»å‹éªŒè¯**ï¼šä¸¥æ ¼çš„æ–‡ä»¶ç±»å‹å’Œå¤§å°éªŒè¯
- **å­˜å‚¨æ‰©å±•**ï¼šæ¥å£åŒ–è®¾è®¡ï¼Œæ”¯æŒæ‰©å±•åˆ°äº‘å­˜å‚¨

### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§
- **ç”¨æˆ·è®¤è¯**ï¼šé™¤é…ç½®æŸ¥è¯¢å¤–ï¼Œæ‰€æœ‰æ¥å£éœ€è¦è®¤è¯
- **æ–‡ä»¶éªŒè¯**ï¼šMIMEç±»å‹ã€æ‰©å±•åã€æ–‡ä»¶åå®‰å…¨éªŒè¯
- **å¤§å°é™åˆ¶**ï¼šå¯é…ç½®çš„æ–‡ä»¶å¤§å°é™åˆ¶
- **MD5æ ¡éªŒ**ï¼šç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§

## API æ¥å£

### 1. è·å–ä¸Šä¼ é…ç½®
```http
GET /api/v1/upload/config
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "è·å–ä¸Šä¼ é…ç½®æˆåŠŸ",
  "data": {
    "maxFileSize": 5368709120,
    "allowedMimeTypes": {
      "image/jpeg": true,
      "image/png": true,
      "video/mp4": true,
      "application/pdf": true
    },
    "chunkSize": 2097152
  }
}
```

### 2. ç®€å•æ–‡ä»¶ä¸Šä¼ 
```http
POST /api/v1/upload/simple
Content-Type: multipart/form-data
Authorization: Bearer {token}
```

**è¯·æ±‚å‚æ•°ï¼š**
- `file` (file, required): ä¸Šä¼ çš„æ–‡ä»¶
- `description` (string, optional): æ–‡ä»¶æè¿°

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ",
  "data": {
    "fileID": "123e4567-e89b-12d3-a456-426614174000",
    "filename": "example.jpg",
    "storedName": "123e4567-e89b-12d3-a456-426614174000.jpg",
    "fileSize": 1024000,
    "mimeType": "image/jpeg",
    "extension": ".jpg",
    "md5Hash": "098f6bcd4621d373cade4e832627b4f6",
    "filePath": "./uploads/123e4567-e89b-12d3-a456-426614174000.jpg",
    "uploadedAt": "2024-12-20T10:30:00Z"
  }
}
```

### 3. åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ 
```http
POST /api/v1/upload/chunk/init
Content-Type: application/json
Authorization: Bearer {token}
```

**è¯·æ±‚ä½“ï¼š**
```json
{
  "filename": "large_video.mp4",
  "fileSize": 104857600,
  "md5Hash": "098f6bcd4621d373cade4e832627b4f6",
  "chunkSize": 2097152
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "åˆ†ç‰‡ä¸Šä¼ åˆå§‹åŒ–æˆåŠŸ",
  "data": {
    "fileID": "123e4567-e89b-12d3-a456-426614174000",
    "chunkSize": 2097152,
    "chunkTotal": 50,
    "uploadToken": ""
  }
}
```

### 4. ä¸Šä¼ åˆ†ç‰‡
```http
POST /api/v1/upload/chunk
Content-Type: multipart/form-data
Authorization: Bearer {token}
```

**è¯·æ±‚å‚æ•°ï¼š**
- `fileID` (string, required): æ–‡ä»¶ID
- `chunkIndex` (int, required): åˆ†ç‰‡ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
- `md5Hash` (string, required): åˆ†ç‰‡MD5å“ˆå¸Œ
- `chunk` (file, required): åˆ†ç‰‡æ–‡ä»¶

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "åˆ†ç‰‡ä¸Šä¼ æˆåŠŸ",
  "data": {
    "fileID": "123e4567-e89b-12d3-a456-426614174000",
    "chunkIndex": 0,
    "chunkUploaded": 1,
    "chunkTotal": 50,
    "isCompleted": false
  }
}
```

### 5. åˆå¹¶åˆ†ç‰‡
```http
POST /api/v1/upload/chunk/merge
Content-Type: application/json
Authorization: Bearer {token}
```

**è¯·æ±‚ä½“ï¼š**
```json
{
  "fileID": "123e4567-e89b-12d3-a456-426614174000"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "åˆ†ç‰‡åˆå¹¶æˆåŠŸ",
  "data": {
    "fileID": "123e4567-e89b-12d3-a456-426614174000",
    "filename": "large_video.mp4",
    "storedName": "123e4567-e89b-12d3-a456-426614174000.mp4",
    "fileSize": 104857600,
    "mimeType": "video/mp4",
    "extension": ".mp4",
    "md5Hash": "098f6bcd4621d373cade4e832627b4f6",
    "filePath": "./uploads/123e4567-e89b-12d3-a456-426614174000.mp4",
    "uploadedAt": "2024-12-20T10:35:00Z"
  }
}
```

### 6. æŸ¥è¯¢ä¸Šä¼ è¿›åº¦
```http
GET /api/v1/upload/progress/{fileID}
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "è·å–ä¸Šä¼ è¿›åº¦æˆåŠŸ",
  "data": {
    "fileID": "123e4567-e89b-12d3-a456-426614174000",
    "filename": "large_video.mp4",
    "fileSize": 104857600,
    "chunkTotal": 50,
    "chunkUploaded": 25,
    "progress": 50.0,
    "status": 1
  }
}
```

## é…ç½®è¯´æ˜

### ä¸Šä¼ é™åˆ¶é…ç½®
```go
// æ–‡ä»¶å¤§å°é™åˆ¶
MaxFileSize = 5GB  // 5 * 1024 * 1024 * 1024

// æ–‡ä»¶åé•¿åº¦é™åˆ¶
MaxFilenameLength = 255

// é»˜è®¤åˆ†ç‰‡å¤§å°
ChunkSize = 2MB  // 2 * 1024 * 1024
```

### æ”¯æŒçš„æ–‡ä»¶ç±»å‹
```go
AllowedMimeTypes = {
    "image/jpeg": true,
    "image/png": true,
    "image/gif": true,
    "image/webp": true,
    "video/mp4": true,
    "video/avi": true,
    "video/mov": true,
    "application/pdf": true,
    "text/plain": true,
    "application/zip": true,
    "application/x-rar-compressed": true,
}
```

### å­˜å‚¨é…ç½®
```go
// é»˜è®¤ä¸Šä¼ ç›®å½•
DefaultUploadDir = "./uploads"

// ä¸´æ—¶åˆ†ç‰‡ç›®å½•
TempChunkDir = "./uploads/tmp"
```

## ä½¿ç”¨æµç¨‹

### ç®€å•ä¸Šä¼ æµç¨‹
```
1. å®¢æˆ·ç«¯ â†’ è·å–ä¸Šä¼ é…ç½®
2. å®¢æˆ·ç«¯ â†’ é€‰æ‹©æ–‡ä»¶å¹¶éªŒè¯
3. å®¢æˆ·ç«¯ â†’ è°ƒç”¨ç®€å•ä¸Šä¼ æ¥å£
4. æœåŠ¡ç«¯ â†’ éªŒè¯æ–‡ä»¶å’Œç”¨æˆ·æƒé™
5. æœåŠ¡ç«¯ â†’ è®¡ç®—MD5ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼ˆç§’ä¼ ï¼‰
6. æœåŠ¡ç«¯ â†’ ä¿å­˜æ–‡ä»¶åˆ°æœ¬åœ°å­˜å‚¨
7. æœåŠ¡ç«¯ â†’ åˆ›å»ºæ•°æ®åº“è®°å½•
8. æœåŠ¡ç«¯ â†’ è¿”å›æ–‡ä»¶ä¿¡æ¯
```

### åˆ†ç‰‡ä¸Šä¼ æµç¨‹
```
1. å®¢æˆ·ç«¯ â†’ è·å–ä¸Šä¼ é…ç½®
2. å®¢æˆ·ç«¯ â†’ æ–‡ä»¶åˆ†ç‰‡å¹¶è®¡ç®—MD5
3. å®¢æˆ·ç«¯ â†’ åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ 
4. æœåŠ¡ç«¯ â†’ æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆç§’ä¼ ï¼‰
5. æœåŠ¡ç«¯ â†’ åˆ›å»ºæ–‡ä»¶å’Œåˆ†ç‰‡è®°å½•
6. å®¢æˆ·ç«¯ â†’ å¹¶å‘ä¸Šä¼ åˆ†ç‰‡
7. æœåŠ¡ç«¯ â†’ ä¿å­˜åˆ†ç‰‡åˆ°ä¸´æ—¶ç›®å½•
8. å®¢æˆ·ç«¯ â†’ æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆåè°ƒç”¨åˆå¹¶
9. æœåŠ¡ç«¯ â†’ åˆå¹¶åˆ†ç‰‡ä¸ºå®Œæ•´æ–‡ä»¶
10. æœåŠ¡ç«¯ â†’ æ›´æ–°æ•°æ®åº“çŠ¶æ€
11. æœåŠ¡ç«¯ â†’ æ¸…ç†ä¸´æ—¶åˆ†ç‰‡æ–‡ä»¶
```

## å‰ç«¯ä½¿ç”¨ç¤ºä¾‹

### JavaScript ç®€å•ä¸Šä¼ 
```javascript
async function simpleUpload(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('description', 'æµ‹è¯•æ–‡ä»¶');
    
    const response = await fetch('/api/v1/upload/simple', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        body: formData
    });
    
    return await response.json();
}
```

### JavaScript åˆ†ç‰‡ä¸Šä¼ 
```javascript
async function chunkUpload(file) {
    const chunkSize = 2 * 1024 * 1024; // 2MB
    const chunks = Math.ceil(file.size / chunkSize);
    
    // 1. åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ 
    const initResponse = await fetch('/api/v1/upload/chunk/init', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
            filename: file.name,
            fileSize: file.size,
            md5Hash: await calculateMD5(file),
            chunkSize: chunkSize
        })
    });
    
    const { fileID } = (await initResponse.json()).data;
    
    // 2. ä¸Šä¼ åˆ†ç‰‡
    for (let i = 0; i < chunks; i++) {
        const start = i * chunkSize;
        const end = Math.min(start + chunkSize, file.size);
        const chunk = file.slice(start, end);
        
        const formData = new FormData();
        formData.append('fileID', fileID);
        formData.append('chunkIndex', i);
        formData.append('md5Hash', await calculateMD5(chunk));
        formData.append('chunk', chunk);
        
        await fetch('/api/v1/upload/chunk', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
    }
    
    // 3. åˆå¹¶åˆ†ç‰‡
    const mergeResponse = await fetch('/api/v1/upload/chunk/merge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ fileID })
    });
    
    return await mergeResponse.json();
}
```

## çŠ¶æ€ç è¯´æ˜

### ä¸Šä¼ çŠ¶æ€
- `1`: ä¸Šä¼ ä¸­
- `2`: ä¸Šä¼ å®Œæˆ
- `3`: ä¸Šä¼ å¤±è´¥

### é”™è¯¯ç 
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `401`: æœªè®¤è¯æˆ–è®¤è¯å¤±è´¥
- `413`: æ–‡ä»¶è¿‡å¤§
- `415`: ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

## æ•°æ®åº“ç»“æ„

### æ–‡ä»¶ä¸Šä¼ è®°å½•è¡¨ (upload_file)
```sql
CREATE TABLE upload_file (
    id CHAR(36) PRIMARY KEY,
    filename VARCHAR(255) NOT NULL,
    stored_name VARCHAR(255) NOT NULL UNIQUE,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    extension VARCHAR(20) NOT NULL,
    md5_hash VARCHAR(32) NOT NULL,
    upload_status INT DEFAULT 1,
    chunk_total INT DEFAULT 1,
    chunk_uploaded INT DEFAULT 0,
    user_id CHAR(36) NOT NULL,
    uploaded_at DATETIME NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    deleted_at DATETIME NULL
);
```

### åˆ†ç‰‡ä¿¡æ¯è¡¨ (chunk_info)
```sql
CREATE TABLE chunk_info (
    id CHAR(36) PRIMARY KEY,
    file_id CHAR(36) NOT NULL,
    chunk_index INT NOT NULL,
    chunk_size BIGINT NOT NULL,
    chunk_path VARCHAR(500) NOT NULL,
    md5_hash VARCHAR(32) NOT NULL,
    is_uploaded BOOLEAN DEFAULT FALSE,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    deleted_at DATETIME NULL
);
```

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„å­˜å‚¨åç«¯
å®ç° `upload.Storage` æ¥å£ï¼š

```go
type Storage interface {
    SaveFile(filename string, file multipart.File) (string, error)
    SaveChunk(chunkPath string, chunk io.Reader) error
    MergeChunks(chunkPaths []string, targetPath string) error
    DeleteFile(filePath string) error
    FileExists(filePath string) bool
    GetFileSize(filePath string) (int64, error)
}
```

### äº‘å­˜å‚¨ç¤ºä¾‹
```go
type CloudStorage struct {
    client CloudClient
}

func (cs *CloudStorage) SaveFile(filename string, file multipart.File) (string, error) {
    // å®ç°äº‘å­˜å‚¨ä¸Šä¼ é€»è¾‘
    return cs.client.Upload(filename, file)
}
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¹¶å‘ä¸Šä¼ **: å®¢æˆ·ç«¯å¯ä»¥å¹¶å‘ä¸Šä¼ å¤šä¸ªåˆ†ç‰‡
2. **ç¼“å­˜é…ç½®**: ä½¿ç”¨Redisç¼“å­˜æ–‡ä»¶é…ç½®ä¿¡æ¯
3. **å¼‚æ­¥å¤„ç†**: å¤§æ–‡ä»¶åˆå¹¶å¯ä»¥å¼‚æ­¥å¤„ç†
4. **CDNåŠ é€Ÿ**: é™æ€æ–‡ä»¶å¯ä»¥é€šè¿‡CDNåˆ†å‘
5. **å‹ç¼©ä¼ è¾“**: å¯ç”¨gzipå‹ç¼©å‡å°‘ä¼ è¾“æ—¶é—´

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶æ‰«æ**: å»ºè®®é›†æˆç—…æ¯’æ‰«æ
2. **è®¿é—®æ§åˆ¶**: å®ç°ç»†ç²’åº¦çš„æ–‡ä»¶è®¿é—®æƒé™
3. **å­˜å‚¨åŠ å¯†**: æ•æ„Ÿæ–‡ä»¶å»ºè®®åŠ å¯†å­˜å‚¨
4. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰æ–‡ä»¶æ“ä½œæ—¥å¿—
5. **å®šæœŸæ¸…ç†**: å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œå¤±æ•ˆè®°å½• 