# éƒ¨ç½²æŒ‡å—

æœ¬é¡¹ç›®å·²å°†éƒ¨ç½²åŠŸèƒ½é›†æˆåˆ° Makefile ä¸­ï¼Œæä¾›äº†å®Œæ•´çš„ä¸€é”®éƒ¨ç½²è§£å†³æ–¹æ¡ˆã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®éƒ¨ç½²å‚æ•°
```bash
make deploy-config
```

**è‡ªåŠ¨åŠŸèƒ½**ï¼š
- âœ… **è‡ªåŠ¨æ£€æµ‹SSHå¯†é’¥** - è‡ªåŠ¨æŸ¥æ‰¾ `~/.ssh/id_rsa`ã€`~/.ssh/id_ed25519`ã€`~/.ssh/id_ecdsa`
- âœ… **æ™ºèƒ½è·¯å¾„è·å–** - ä½¿ç”¨ `realpath` è·å–å®Œæ•´è·¯å¾„
- âœ… **å‹å¥½æç¤º** - å¦‚æœæ²¡æœ‰SSHå¯†é’¥ï¼Œæä¾›ç”Ÿæˆå’Œé…ç½®æŒ‡å¯¼

æŒ‰æç¤ºè¾“å…¥ï¼š
- åº”ç”¨åç§° (é»˜è®¤: template)
- è¿œç¨‹ä¸»æœºåœ°å€ (å¿…å¡«)
- è¿œç¨‹ç”¨æˆ·å (é»˜è®¤: root)
- SSHç«¯å£ (é»˜è®¤: 22)
- è¿œç¨‹éƒ¨ç½²ç›®å½• (é»˜è®¤: /opt/myapp)
- SSHå¯†é’¥è·¯å¾„ (è‡ªåŠ¨æ£€æµ‹æˆ–æ‰‹åŠ¨è¾“å…¥)
- éƒ¨ç½²ç¯å¢ƒ (prod/test/devï¼Œé»˜è®¤: prod)

é…ç½®ä¼šä¿å­˜åˆ° `deploy.conf` æ–‡ä»¶ä¸­ã€‚

### 2. åˆå§‹åŒ–æœåŠ¡å™¨ç¯å¢ƒ
```bash
make deploy-setup
```
æ­¤å‘½ä»¤ä¼šï¼š
- åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
- ä¸Šä¼ æœåŠ¡ç®¡ç†è„šæœ¬ (`service.sh`)
- è®¾ç½®æ­£ç¡®çš„æƒé™

### 3. éƒ¨ç½²åº”ç”¨

#### æ–¹å¼ä¸€ï¼šä¸€é”®æ‰“åŒ…å¹¶éƒ¨ç½²
```bash
make build-deploy
```

#### æ–¹å¼äºŒï¼šåˆ†æ­¥éƒ¨ç½²
```bash
make deploy-package  # åˆ›å»ºéƒ¨ç½²åŒ…
make deploy          # éƒ¨ç½²åº”ç”¨
```

## ğŸ“¦ éƒ¨ç½²åŒ…è¯´æ˜

éƒ¨ç½²åŒ…å­˜å‚¨åœ¨ `release/` ç›®å½•ä¸­ï¼ŒåŒ…å«ï¼š
- **ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶** - åŒ…å«åµŒå…¥å¼é™æ€æ–‡ä»¶
- **ç¯å¢ƒé…ç½®æ–‡ä»¶** - æ ¹æ® `DEPLOY_ENV` è‡ªåŠ¨é€‰æ‹©ï¼š
  - `prod` â†’ `config.prod.yaml`
  - `test` â†’ `config.test.yaml`
  - `dev` â†’ `config.dev.yaml`
  - é»˜è®¤ â†’ `config.yaml`

## ğŸ”§ ç®¡ç†å‘½ä»¤

### åˆ›å»ºéƒ¨ç½²åŒ…
```bash
make deploy-package  # åˆ›å»ºéƒ¨ç½²åŒ…åˆ°releaseç›®å½•
```

### ä»…éƒ¨ç½² (ä¸æ‰“åŒ…)
```bash
make deploy
```
æ³¨æ„ï¼šéœ€è¦å…ˆè¿è¡Œ `make deploy-package` åˆ›å»ºéƒ¨ç½²åŒ…

### æŸ¥çœ‹éƒ¨ç½²é…ç½®
```bash
make deploy-check  # æ˜¾ç¤ºå½“å‰é…ç½®
```

### æŸ¥çœ‹åº”ç”¨çŠ¶æ€
```bash
make deploy-status
```

### æŸ¥çœ‹åº”ç”¨æ—¥å¿—
```bash
make deploy-logs
# æˆ–æŒ‡å®šè¡Œæ•°
LINES=100 make deploy-logs
```

### é‡å¯åº”ç”¨
```bash
make deploy-restart
```

### å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
```bash
make deploy-rollback
```

## ğŸ› ï¸ æœåŠ¡ç®¡ç†

è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ `service.sh` è„šæœ¬æ”¯æŒä»¥ä¸‹å‘½ä»¤ï¼š
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
/path/to/deploy/service.sh start    # å¯åŠ¨åº”ç”¨
/path/to/deploy/service.sh stop     # åœæ­¢åº”ç”¨
/path/to/deploy/service.sh restart  # é‡å¯åº”ç”¨
/path/to/deploy/service.sh status   # æŸ¥çœ‹çŠ¶æ€
/path/to/deploy/service.sh logs 50  # æŸ¥çœ‹æ—¥å¿—
```

## ğŸ” SSHå¯†é’¥é…ç½®

### å¦‚æœæ²¡æœ‰SSHå¯†é’¥ï¼š
```bash
# ç”ŸæˆSSHå¯†é’¥
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa

# å¤åˆ¶å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id -i ~/.ssh/id_rsa.pub root@your-server.com
```

### æ”¯æŒçš„å¯†é’¥ç±»å‹ï¼š
- RSA: `~/.ssh/id_rsa`
- Ed25519: `~/.ssh/id_ed25519`
- ECDSA: `~/.ssh/id_ecdsa`

## ğŸ“‹ å®Œæ•´éƒ¨ç½²æµç¨‹

### æ–¹å¼ä¸€ï¼šä¸€é”®éƒ¨ç½²
```bash
# 1. é…ç½®éƒ¨ç½²å‚æ•° (é¦–æ¬¡)
make deploy-config

# 2. åˆå§‹åŒ–æœåŠ¡å™¨ç¯å¢ƒ (é¦–æ¬¡)
make deploy-setup

# 3. ä¸€é”®æ‰“åŒ…å¹¶éƒ¨ç½²
make build-deploy

# 4. æŸ¥çœ‹çŠ¶æ€
make deploy-status

# 5. æŸ¥çœ‹æ—¥å¿—
make deploy-logs
```

### æ–¹å¼äºŒï¼šåˆ†æ­¥éƒ¨ç½²
```bash
# 1. é…ç½®éƒ¨ç½²å‚æ•° (é¦–æ¬¡)
make deploy-config

# 2. åˆå§‹åŒ–æœåŠ¡å™¨ç¯å¢ƒ (é¦–æ¬¡)
make deploy-setup

# 3. åˆ›å»ºéƒ¨ç½²åŒ…
make deploy-package

# 4. éƒ¨ç½²åº”ç”¨
make deploy

# 5. æŸ¥çœ‹çŠ¶æ€
make deploy-status

# 6. æŸ¥çœ‹æ—¥å¿—
make deploy-logs
```

## ğŸ¯ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

é¡¹ç›®å·²åŒ…å«ç”Ÿäº§ç¯å¢ƒé…ç½® `config.prod.yaml`ï¼š
- å‘å¸ƒæ¨¡å¼ (`mode: release`)
- ç¦ç”¨è°ƒè¯•æ—¥å¿—
- ä¼˜åŒ–çš„CORSè®¾ç½®
- ç”Ÿäº§çº§å®‰å…¨é…ç½®

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜ï¼š

1. **SSHè¿æ¥å¤±è´¥**
   - æ£€æŸ¥SSHå¯†é’¥æƒé™ï¼š`chmod 600 ~/.ssh/id_rsa`
   - éªŒè¯æœåŠ¡å™¨è¿æ¥ï¼š`ssh -i ~/.ssh/id_rsa root@your-server.com`

2. **service.shä¸å­˜åœ¨**
   - è¿è¡Œ `make deploy-setup` é‡æ–°åˆå§‹åŒ–

3. **åº”ç”¨å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥æ—¥å¿—ï¼š`make deploy-logs`
   - æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®

4. **ç«¯å£å†²çª**
   - ä¿®æ”¹ `config.prod.yaml` ä¸­çš„ç«¯å£è®¾ç½®
   - é‡æ–°éƒ¨ç½²ï¼š`make deploy`

## ğŸ’¡ é«˜çº§ç”¨æ³•

### å¤šç¯å¢ƒéƒ¨ç½²
```bash
# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
DEPLOY_ENV=test make deploy

# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ  
DEPLOY_ENV=dev make deploy
```

### è‡ªå®šä¹‰é…ç½®
ç¼–è¾‘ `deploy.conf` æ–‡ä»¶ç›´æ¥ä¿®æ”¹é…ç½®ï¼Œæˆ–é‡æ–°è¿è¡Œ `make deploy-config`ã€‚

---

ğŸ‰ ç°åœ¨ä½ å¯ä»¥äº«å—ä¸€é”®éƒ¨ç½²çš„ä¾¿åˆ©ï¼ 